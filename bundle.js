(()=>{"use strict";(()=>{const e={400:"Что-то пошло не так... Неверный запрос",401:"Что-то пошло не так... Пользователь не авторизован",404:"Что-то пошло не так... Ничего не найдено"},t=document.querySelector(".map__pins"),o=(t,o,n)=>{t.addEventListener("load",(()=>{200===t.status?o(t.response):n(e[t.status])})),t.timeout=1e4,t.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),t.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+t.timeout+"мс")}))};window.data={load:(e,t)=>{const n=new XMLHttpRequest;n.responseType="json",o(n,e,t),n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save:(e,t,n)=>{const i=new XMLHttpRequest;i.responseType="json",o(i,t,n),i.open("POST","https://21.javascript.pages.academy/keksobooking"),i.send(e)},similarAds:t}})(),(()=>{const e="any",t="low",o="middle",n="high",i=1e4,d=5e4,r=document.querySelector(".map__filters"),a=document.querySelector("#housing-type"),s=document.querySelector("#housing-price"),l=document.querySelector("#housing-rooms"),c=document.querySelector("#housing-guests"),m=document.querySelector(".map__filters");window.sort={sortFilters:r};const p=()=>{const r=window.map.sortedList.filter((r=>{const p=r.offer.type===a.value||a.value===e,w=(u=r,s.value===t?u.offer.price<i:s.value===o?u.offer.price>=i&&u.offer.price<=d:s.value===n?u.offer.price>d:u.offer.price>0);var u;const f=r.offer.rooms===Number(l.value)||l.value===e,v=r.offer.guests===Number(c.value)||c.value===e,y=(()=>{const e=m.querySelectorAll("input:checked");return Array.from(e).map((e=>e.value))})().every((e=>r.offer.features.includes(e)));return p&&w&&f&&v&&y})).slice(0);window.map.renderNewPin(r)};window.sort.sortFilters.addEventListener("change",(()=>{window.debounce.getTimeout(p)}))})(),(()=>{const e={palace:"Дворец",flat:"Квартира",bungalow:"Бунгало",house:"Дом"},t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.querySelector("#card").content.querySelector(".map__card");window.card={renderSimilarAds:e=>{const o=t.cloneNode(!0);o.style="left: "+(e.location.x+o.style.width)+"px; top: "+(e.location.y+o.style.height)+"px;";const n=o.querySelector("img");return n.src=e.author.avatar,n.alt=e.offer.title,o},renderAds:t=>{const n=o.cloneNode(!0),i=n.querySelector(".popup__title"),d=n.querySelector(".popup__text--address"),r=n.querySelector(".popup__text--price"),a=n.querySelector(".popup__type"),s=n.querySelector(".popup__text--capacity"),l=n.querySelector(".popup__text--time"),c=n.querySelector(".popup__features"),m=c.querySelectorAll(".popup__feature"),p=n.querySelector(".popup__description"),w=n.querySelector(".popup__photos"),u=w.querySelector(".popup__photo"),f=n.querySelector(".popup__avatar");if(i.textContent=t.offer.title,d.textContent=t.offer.address,r.textContent=t.offer.price+"₽/ночь",a.textContent=e[t.offer.type],s.textContent=t.offer.rooms+" комнаты для "+t.offer.guests+" гостей.",l.textContent="Заезд после "+t.offer.checkin+", выезд до "+t.offer.checkout+".",m.forEach((e=>{e.remove()})),t.offer.features.length>0)for(let e=0;e<t.offer.features.length;e++){let o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+t.offer.features[e]),c.appendChild(o)}if(p.textContent=t.offer.description,u.src=t.offer.photos[0],t.offer.photos.length>1)for(let e=1;e<t.offer.photos.length;e++){let o=u.cloneNode(!0),n=document.createDocumentFragment();o.src=t.offer.photos[e],n.append(o),w.append(n)}else 0===t.offer.photos.length&&u.remove();return f.src=t.author.avatar,n.classList.add("hidden"),n}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__filters-container");let o,n;window.map={sortedList:[],ESC_KEYCODE:27,ENTER_KEYCODE:13,isEscKeyCode:(e,t)=>{e.keyCode===window.map.ESC_KEYCODE&&(e.preventDefault(),t())},isEnterKeyCode:(e,t)=>{e.keyCode===window.map.ENTER_KEYCODE&&(e.preventDefault(),t())},renderPin:()=>{window.data.load(i,d)},addListenerCards:()=>{const e=window.map.getElements(".map__pin:not(.map__pin--main)"),t=document.querySelectorAll(".popup"),i=document.querySelectorAll(".popup__close");t.forEach(((d,r)=>{e[r].addEventListener("click",(()=>{l(t,e),o=d,n=e[r],a()})),e[r].addEventListener("keydown",(i=>{i.keyCode===window.map.ENTER_KEYCODE&&(l(t,e),o=d,n=e[r],a())})),i[r].addEventListener("click",(()=>{s()})),i[r].addEventListener("keydown",(e=>{window.map.isEnterKeyCode(e,s)}))}))},getElements:e=>document.querySelectorAll(e),clearElement:e=>{e.forEach((e=>{e.remove()}))},renderNewPin:o=>{window.map.clearElement(window.map.getElements(".map__pin:not(.map__pin--main)")),window.map.clearElement(window.map.getElements(".popup"));const n=document.createDocumentFragment(),i=document.createDocumentFragment(),d=5>o.length?o.length:5;for(let r=0;r<d;r++)n.appendChild(window.card.renderSimilarAds(o[r])),i.appendChild(window.card.renderAds(o[r])),window.data.similarAds.appendChild(n),e.insertBefore(i,t);window.map.addListenerCards()}};const i=e=>{window.map.sortedList=e,window.map.renderNewPin(window.map.sortedList)},d=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: white; border: 1px red solid; width: 100%; height: 40px;",t.style.position="absolute",t.style.left=0,t.style.fontSize="18px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},r=e=>{window.map.isEscKeyCode(e,s)},a=()=>{o.classList.remove("hidden"),n.classList.add("map__pin--active"),document.addEventListener("keydown",r)},s=()=>{o.classList.add("hidden"),n.classList.remove("map__pin--active"),document.removeEventListener("keydown",r)},l=(e,t)=>{e.forEach(((e,o)=>{e.classList.contains("hidden")||(e.classList.add("hidden"),t[o].classList.remove("map__pin--active"))}))}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),o=630-e.offsetHeight,n=t.offsetLeft,i=t.offsetWidth-e.offsetWidth/2;window.move={getAddress:(e,t,o,n)=>{e.value=n?Math.floor(parseInt(t.style.left,10)+t.offsetWidth/2)+", "+Math.floor(parseInt(t.style.top,10)+t.offsetHeight/2):Math.floor(parseInt(t.style.left,10)+t.offsetWidth/2)+", "+Math.floor(parseInt(t.style.top,10)+t.offsetHeight+o)},pin:e,angle:22,generalMap:t},window.move.pin.addEventListener("mousedown",(t=>{t.preventDefault();let d={x:t.clientX,y:t.clientY};const r=t=>{if(!window.main.check){t.preventDefault();let r={x:d.x-t.clientX,y:d.y-t.clientY};d={x:t.clientX,y:t.clientY},t.clientX<i+n&&t.clientX>n&&(window.move.pin.style.left=window.move.pin.offsetLeft-r.x+"px"),t.clientY<700&&t.clientY>0&&(window.move.pin.style.top=window.move.pin.offsetTop-r.y+"px"),t.pageX>i+n+e.offsetWidth?window.move.pin.style.left=i+"px":t.pageX<n&&(window.move.pin.style.left=n-n-e.offsetWidth/2+"px"),t.pageY>o-22?window.move.pin.style.top=o-22+"px":t.pageY<130-e.offsetHeight-22&&(window.move.pin.style.top=130-e.offsetHeight-22+"px"),window.move.getAddress(window.main.address,window.move.pin,window.move.angle,window.main.check)}},a=e=>{e.preventDefault(),window.move.getAddress(window.main.address,window.move.pin,window.move.angle,window.main.check),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)}))})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelectorAll(".map__filter"),o=document.querySelector(".map__features"),n=document.querySelector("input[name=address]");window.main={siteForm:e,address:n,check:!0,disabledMap:()=>{window.move.pin.style.left="570px",window.move.pin.style.top="375px",window.main.check?(window.map.clearElement(window.map.getElements(".map__pin:not(.map__pin--main)")),window.map.clearElement(window.map.getElements(".map__card")),window.move.generalMap.classList.add("map--faded"),e.classList.add("ad-form--disabled"),d(window.main.check)):(window.move.generalMap.classList.remove("map--faded"),e.classList.remove("ad-form--disabled"),d(window.main.check))},addActiveMap:()=>{window.main.disabledMap(),window.move.getAddress(window.main.address,window.move.pin,window.move.angle,window.main.check),window.move.generalMap.classList.contains("map--faded")&&(window.move.pin.addEventListener("keydown",r),window.move.pin.addEventListener("mousedown",a))}};const i=window.main.siteForm.querySelectorAll("fieldset"),d=e=>{i.forEach((t=>{t.disabled=e})),t.forEach((t=>{t.disabled=e})),o.disabled=e},r=e=>{e.keyCode===window.map.ENTER_KEYCODE&&(l(),window.move.generalMap.classList.contains("map--faded")||s())},a=e=>{1===e.which&&(l(),window.move.generalMap.classList.contains("map--faded")||s())},s=()=>{window.move.pin.removeEventListener("keydown",r),window.move.pin.removeEventListener("mousedown",a)},l=()=>{window.main.check=!1,window.main.disabledMap(),window.move.getAddress(window.main.address,window.move.pin,window.move.angle,window.main.check),window.map.renderPin()};window.main.addActiveMap()})(),(()=>{const e=window.main.siteForm.querySelector("#timein"),t=window.main.siteForm.querySelector("#timeout"),o=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error"),i=document.querySelector("main"),d=window.main.siteForm.querySelector("#room_number"),r=window.main.siteForm.querySelector("#capacity"),a=window.main.siteForm.querySelector("#type"),s=window.main.siteForm.querySelector("#price"),l=document.querySelector(".ad-form__reset");let c;const m=()=>{d.value<r.value?(d.setCustomValidity("Все гости не поместятся! Давайте выберем побольше комнат"),d.reportValidity()):"100"===d.value&&"0"!==r.value?(d.setCustomValidity("Это помещение не для гостей!"),d.reportValidity()):"0"===r.value&&"100"!==d.value?(d.setCustomValidity("Выберете помещение с 100 комнатами"),d.reportValidity()):(d.setCustomValidity(""),d.reportValidity())};e.addEventListener("change",(()=>{t.value!==e.value&&(t.value=e.value)})),t.addEventListener("change",(()=>{e.value!==t.value&&(e.value=t.value)})),d.addEventListener("change",(()=>{m()})),r.addEventListener("change",(()=>{m()})),window.main.siteForm.addEventListener("change",(()=>{"bungalow"===a.value?s.min="0":"flat"===a.value?s.min="1000":"house"===a.value?s.min="5000":"palace"===a.value&&(s.min="10000"),s.placeholder=s.min}));const p=e=>{window.map.isEscKeyCode(e,w)},w=()=>{c.remove(),document.removeEventListener("keydown",p)},u=e=>{c=e.cloneNode(!0);const t=document.createDocumentFragment();t.appendChild(c),i.appendChild(t),document.addEventListener("click",(()=>{w()})),document.addEventListener("keydown",p);const o=c.querySelector(".error__button");o&&o.addEventListener("click",(e=>{window.main.siteForm.reset(),window.sort.sortFilters.reset(),e.preventDefault(),w()}))};l.addEventListener("click",(()=>{window.main.siteForm.reset(),window.sort.sortFilters.reset(),window.main.check=!0,window.main.addActiveMap()}));const f=()=>{window.main.siteForm.reset(),window.sort.sortFilters.reset(),u(o),window.main.check=!0,window.main.addActiveMap()},v=()=>{u(n)};window.main.siteForm.addEventListener("submit",(e=>{e.preventDefault(),r.value>d.value?(d.setCustomValidity("Все гости не поместятся! Давайте выберем побольше комнат"),d.reportValidity()):window.data.save(new FormData(window.main.siteForm),f,v)}))})(),(()=>{let e;window.debounce={getTimeout:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}})(),(()=>{const e=["jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload input[type=file]"),i=document.querySelector(".ad-form__photo");t.addEventListener("change",(()=>{let n=t.files[0],i=n.name.toLowerCase();if(e.some((e=>i.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}})),n.addEventListener("change",(()=>{let t=n.files[0],o=t.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{let t=document.createElement("img");t.src=e.result,t.classList.add("ad-form__photo"),i.appendChild(t)})),e.readAsDataURL(t)}}))})()})();