(()=>{"use strict";(()=>{const e={400:"Что-то пошло не так... Неверный запрос",401:"Что-то пошло не так... Пользователь не авторизован",404:"Что-то пошло не так... Ничего не найдено"},t=document.querySelector(".map__pins"),o=(t,o,n)=>{t.addEventListener("load",(()=>{200===t.status?o(t.response):n(e[t.status])})),t.timeout=1e4,t.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),t.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${t.timeout}мc`)}))};window.data={load:(e,t)=>{const n=new XMLHttpRequest;n.responseType="json",o(n,e,t),n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save:(e,t,n)=>{const i=new XMLHttpRequest;i.responseType="json",o(i,t,n),i.open("POST","https://21.javascript.pages.academy/keksobooking"),i.send(e)},similarAds:t}})(),(()=>{const e="any",t="low",o="middle",n="high",i=1e4,d=5e4,a=document.querySelector(".map__filters"),r=document.querySelector("#housing-type"),s=document.querySelector("#housing-price"),c=document.querySelector("#housing-rooms"),l=document.querySelector("#housing-guests"),m=document.querySelector(".map__filters"),p=()=>{const a=window.map.sortedList.filter((a=>{const p=a.offer.type===r.value||r.value===e,w=(u=a,s.value===t?u.offer.price<i:s.value===o?u.offer.price>=i&&u.offer.price<=d:s.value===n?u.offer.price>d:u.offer.price>0);var u;const v=a.offer.rooms===Number(c.value)||c.value===e,f=a.offer.guests===Number(l.value)||l.value===e,y=(()=>{const e=m.querySelectorAll("input:checked");return Array.from(e).map((e=>e.value))})().every((e=>a.offer.features.includes(e)));return p&&w&&v&&f&&y})).slice(0,window.map.count);window.map.renderNewPin(a)};a.addEventListener("change",(()=>{window.debounce.getTimeout(p)})),window.sort={sortFilters:a}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",bungalow:"Бунгало",house:"Дом"},t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.querySelector("#card").content.querySelector(".map__card");window.card={renderSimilarAds:e=>{const o=t.cloneNode(!0);o.style=`left: ${e.location.x+o.style.width}px; top: ${e.location.y+o.style.height}px`;const n=o.querySelector("img");return n.src=e.author.avatar,n.alt=e.offer.title,o},renderAds:t=>{const{offer:{title:n,address:i,price:d,type:a,rooms:r,guests:s,checkin:c,checkout:l,features:m,description:p,photos:w},author:{avatar:u}}=t,v=o.cloneNode(!0),f=v.querySelector(".popup__title"),y=v.querySelector(".popup__text--address"),h=v.querySelector(".popup__text--price"),_=v.querySelector(".popup__type"),g=v.querySelector(".popup__text--capacity"),E=v.querySelector(".popup__text--time"),L=v.querySelector(".popup__features"),S=L.querySelectorAll(".popup__feature"),q=v.querySelector(".popup__description"),C=v.querySelector(".popup__photos"),k=C.querySelector(".popup__photo"),x=v.querySelector(".popup__avatar");if(f.textContent=n,y.textContent=i,h.textContent=d+"₽/ночь",_.textContent=e[a],g.textContent=`${r} комнаты для ${s} гостей.`,E.textContent=`Заезд после ${c}, выезд до ${l}.`,S.forEach((e=>{e.remove()})),m.length>0)for(let e=0;e<m.length;e++){let t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+m[e]),L.appendChild(t)}if(q.textContent=p,k.src=w[0],w.length>1)for(let e=1;e<w.length;e++){let t=k.cloneNode(!0),o=document.createDocumentFragment();t.src=w[e],o.append(t),C.append(o)}else 0===w.length&&k.remove();return x.src=u,v.classList.add("hidden"),v}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__filters-container");let o,n;window.map={count:5,sortedList:[],ESC_KEYCODE:27,ENTER_KEYCODE:13,isEscKeyCode:(e,t)=>{e.keyCode===window.map.ESC_KEYCODE&&(e.preventDefault(),t())},isEnterKeyCode:(e,t)=>{e.keyCode===window.map.ENTER_KEYCODE&&(e.preventDefault(),t())},renderPin:()=>{window.data.load(i,d)},addListenerCards:()=>{const e=window.map.getElements(".map__pin:not(.map__pin--main)"),t=document.querySelectorAll(".popup"),i=document.querySelectorAll(".popup__close");t.forEach(((d,a)=>{e[a].addEventListener("click",(()=>{c(t,e),o=d,n=e[a],r()})),e[a].addEventListener("keydown",(i=>{i.keyCode===window.map.ENTER_KEYCODE&&(c(t,e),o=d,n=e[a],r())})),i[a].addEventListener("click",(()=>{s()})),i[a].addEventListener("keydown",(e=>{window.map.isEnterKeyCode(e,s)}))}))},getElements:e=>document.querySelectorAll(e),clearElement:e=>{e.forEach((e=>{e.remove()}))},renderNewPin:o=>{window.map.clearElement(window.map.getElements(".map__pin:not(.map__pin--main)")),window.map.clearElement(window.map.getElements(".popup"));const n=document.createDocumentFragment(),i=document.createDocumentFragment(),d=window.map.count>o.length?o.length:window.map.count;for(let a=0;a<d;a++)n.appendChild(window.card.renderSimilarAds(o[a])),i.appendChild(window.card.renderAds(o[a])),window.data.similarAds.appendChild(n),e.insertBefore(i,t);window.map.addListenerCards()}};const i=e=>{window.map.sortedList=e,window.map.renderNewPin(window.map.sortedList)},d=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: white; border: 1px red solid; width: 100%; height: 40px;",t.style.position="absolute",t.style.left=0,t.style.fontSize="18px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},a=e=>{window.map.isEscKeyCode(e,s)},r=()=>{o.classList.remove("hidden"),n.classList.add("map__pin--active"),document.addEventListener("keydown",a)},s=()=>{o.classList.add("hidden"),n.classList.remove("map__pin--active"),document.removeEventListener("keydown",a)},c=(e,t)=>{e.forEach(((e,o)=>{e.classList.contains("hidden")||(e.classList.add("hidden"),t[o].classList.remove("map__pin--active"))}))}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),o=630-e.offsetHeight,n=t.offsetLeft,i=t.offsetWidth-e.offsetWidth/2;window.move={getAddress:(e,t,o,n)=>{e.value=n?`${Math.floor(parseInt(t.style.left,10)+t.offsetWidth/2)}, ${Math.floor(parseInt(t.style.top,10)+t.offsetHeight/2)}`:`${Math.floor(parseInt(t.style.left,10)+t.offsetWidth/2)}, ${Math.floor(parseInt(t.style.top,10)+t.offsetHeight+o)}`},pin:e,angle:22,generalMap:t},window.move.pin.addEventListener("mousedown",(t=>{t.preventDefault();let d={x:t.clientX,y:t.clientY};const a=t=>{if(!window.main.check){t.preventDefault();let a={x:d.x-t.clientX,y:d.y-t.clientY};d={x:t.clientX,y:t.clientY},t.clientX<i+n&&t.clientX>n&&(window.move.pin.style.left=window.move.pin.offsetLeft-a.x+"px"),t.clientY<700&&t.clientY>80&&(window.move.pin.style.top=window.move.pin.offsetTop-a.y+"px"),t.pageX>i+n+e.offsetWidth?window.move.pin.style.left=i+"px":t.pageX<n&&(window.move.pin.style.left=n-n-e.offsetWidth/2+"px"),t.pageY>o-22?window.move.pin.style.top=o-22+"px":t.pageY<130-e.offsetHeight-22&&(window.move.pin.style.top=130-e.offsetHeight-22+"px"),window.move.getAddress(window.main.address,window.move.pin,window.move.angle,window.main.check)}},r=e=>{e.preventDefault(),window.move.getAddress(window.main.address,window.move.pin,window.move.angle,window.main.check),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",r)}))})(),(()=>{const e=["jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload input[type=file]"),i=document.querySelector(".ad-form__photo");t.addEventListener("change",(()=>{let n=t.files[0],i=n.name.toLowerCase();if(e.some((e=>i.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{o.src=e.result})),e.readAsDataURL(n)}})),n.addEventListener("change",(()=>{let t=n.files[0],o=t.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{let t=document.createElement("img");t.src=e.result,t.classList.add("ad-form__photo"),i.appendChild(t)})),e.readAsDataURL(t)}})),window.image={clearLoadFoto:()=>{o.src="img/muffin-grey.svg",document.querySelector("img.ad-form__photo")&&window.map.clearElement(window.map.getElements("img.ad-form__photo"))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelectorAll(".map__filter"),o=document.querySelector(".map__features"),n=document.querySelector("input[name=address]");window.main={siteForm:e,address:n,check:!0,disabledMap:()=>{window.move.pin.style.left="570px",window.move.pin.style.top="375px",window.main.check?(window.map.clearElement(window.map.getElements(".map__pin:not(.map__pin--main)")),window.map.clearElement(window.map.getElements(".map__card")),window.move.generalMap.classList.add("map--faded"),e.classList.add("ad-form--disabled"),d(window.main.check)):(window.move.generalMap.classList.remove("map--faded"),e.classList.remove("ad-form--disabled"),d(window.main.check))},addActiveMap:()=>{window.main.disabledMap(),window.move.getAddress(window.main.address,window.move.pin,window.move.angle,window.main.check),window.move.generalMap.classList.contains("map--faded")&&(window.move.pin.addEventListener("keydown",a),window.move.pin.addEventListener("mousedown",r))}};const i=window.main.siteForm.querySelectorAll("fieldset"),d=e=>{i.forEach((t=>{t.disabled=e})),t.forEach((t=>{t.disabled=e})),o.disabled=e},a=e=>{e.keyCode===window.map.ENTER_KEYCODE&&(c(),window.move.generalMap.classList.contains("map--faded")||s())},r=e=>{1===e.which&&(c(),window.move.generalMap.classList.contains("map--faded")||s())},s=()=>{window.move.pin.removeEventListener("keydown",a),window.move.pin.removeEventListener("mousedown",r)},c=()=>{window.main.check=!1,window.main.disabledMap(),window.move.getAddress(window.main.address,window.move.pin,window.move.angle,window.main.check),window.map.renderPin()};window.main.addActiveMap()})(),(()=>{const e="100",t=window.main.siteForm.querySelector("#timein"),o=window.main.siteForm.querySelector("#timeout"),n=document.querySelector("#success").content.querySelector(".success"),i=document.querySelector("#error").content.querySelector(".error"),d=document.querySelector("main"),a=window.main.siteForm.querySelector("#room_number"),r=window.main.siteForm.querySelector("#capacity"),s=window.main.siteForm.querySelector("#type"),c=window.main.siteForm.querySelector("#price"),l=document.querySelector(".ad-form__reset");let m;const p=()=>{r.value>a.value&&a.value!==e?(r.setCustomValidity("Все гости не поместятся! Давайте выберем побольше комнат"),r.reportValidity()):a.value===e&&"0"!==r.value?(r.setCustomValidity("Это помещение не для гостей!"),r.reportValidity()):"0"===r.value&&a.value!==e?(r.setCustomValidity("Выберете помещение с 100 комнатами"),r.reportValidity()):(r.setCustomValidity(""),r.reportValidity())};t.addEventListener("change",(()=>{o.value!==t.value&&(o.value=t.value)})),o.addEventListener("change",(()=>{t.value!==o.value&&(t.value=o.value)})),a.addEventListener("change",(()=>{p()})),r.addEventListener("change",(()=>{p()})),window.main.siteForm.addEventListener("change",(()=>{"bungalow"===s.value?c.min="0":"flat"===s.value?c.min="1000":"house"===s.value?c.min="5000":"palace"===s.value&&(c.min="10000"),c.placeholder=c.min}));const w=e=>{window.map.isEscKeyCode(e,u)},u=()=>{m.remove(),document.removeEventListener("keydown",w)},v=e=>{m=e.cloneNode(!0);const t=document.createDocumentFragment();t.appendChild(m),d.appendChild(t),document.addEventListener("click",(()=>{u()})),document.addEventListener("keydown",w);const o=m.querySelector(".error__button");o&&o.addEventListener("click",(e=>{window.main.siteForm.reset(),window.sort.sortFilters.reset(),e.preventDefault(),u(),window.main.check=!0,window.main.addActiveMap(),window.image.clearLoadFoto()}))};l.addEventListener("click",(()=>{window.main.siteForm.reset(),window.sort.sortFilters.reset(),window.main.check=!0,window.main.addActiveMap(),window.image.clearLoadFoto()}));const f=()=>{window.main.siteForm.reset(),window.sort.sortFilters.reset(),v(n),window.main.check=!0,window.main.addActiveMap(),window.image.clearLoadFoto()},y=()=>{v(i)};window.main.siteForm.addEventListener("submit",(e=>{e.preventDefault(),r.value>a.value?(r.setCustomValidity("Все гости не поместятся! Давайте выберем побольше комнат"),r.reportValidity()):window.data.save(new FormData(window.main.siteForm),f,y)}))})(),(()=>{let e;window.debounce={getTimeout:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}})()})();